#!/bin/bash
# MANA MCP Server - Cross-platform wrapper script
# Downloads the correct binary from GitHub releases on first run

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
REPO="scottymade/mana"

# Detect OS and architecture
OS=$(uname -s | tr '[:upper:]' '[:lower:]')
ARCH=$(uname -m)

# Normalize architecture
case "$ARCH" in
  x86_64|amd64) ARCH="x64" ;;
  arm64|aarch64) ARCH="arm64" ;;
esac

# Select binary name based on OS
case "$OS" in
  darwin) BINARY_NAME="mana-mcp-darwin-$ARCH" ;;
  linux) BINARY_NAME="mana-mcp-linux-x64" ;;
  *) echo "Unsupported OS: $OS" >&2; exit 1 ;;
esac

BINARY_PATH="$SCRIPT_DIR/$BINARY_NAME"

# Download binary if not present
if [ ! -f "$BINARY_PATH" ]; then
  echo "MANA: Downloading $BINARY_NAME..." >&2

  # Get latest release download URL
  DOWNLOAD_URL="https://github.com/$REPO/releases/latest/download/$BINARY_NAME"

  # Download
  if command -v curl &> /dev/null; then
    curl -fsSL "$DOWNLOAD_URL" -o "$BINARY_PATH"
  elif command -v wget &> /dev/null; then
    wget -q "$DOWNLOAD_URL" -O "$BINARY_PATH"
  else
    echo "Error: curl or wget required to download binary" >&2
    exit 1
  fi

  chmod +x "$BINARY_PATH"
  echo "MANA: Downloaded successfully" >&2
fi

exec "$BINARY_PATH" "$@"
